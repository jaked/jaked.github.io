<html><head><title>How to run Electron on Linux on Docker on Mac</title><meta name="twitter:card" content="summary"/><meta name="twitter:site" content="@jakedonham"/><meta name="twitter:creator" content="@jakedonham"/><meta name="twitter:title" content="How to run Electron on Linux on Docker on Mac"/><meta name="twitter:description" content="How to run Electron on Linux on Docker on Mac"/><style>
body {
  background-color: #eeeeee;
}
.content {
  background-color: white;
  padding-top: 80px;
  padding-bottom: 80px;
  padding-left: 120px;
  padding-right: 120px;
  margin-left: auto;
  margin-right: auto;
  max-width: 700px
}
blockquote { margin-block-end: 2em }
p, ul { font-family: serif; font-size: 19px; line-height: 26px }
code { font-family: monospace; font-size: 14px; }
pre { font-family: monospace; font-size: 14px; }
h1, h2, h3, h4, h5, h6 { font-family: sans-serif }
a:link { text-decoration: none; }
a:visited { color: blue }
a:hover {
  background-color: #eeeeee;
}
hr { border-style: solid }
</style>
<script type='module' src='/blog/2021-02-18-How-to-run-Electron-on-Linux-on-Docker-on-Mac.js'></script>
<style data-styled="true" data-styled-version="5.3.0">.bOWasK{background-color:#f7f7f7;margin-left:10px;margin-right:10px;padding:10px;overflow:auto;}/*!sc*/
data-styled.g1[id="sc-bdnxRM"]{content:"bOWasK,"}/*!sc*/
.kFWJEY:hover{cursor:pointer;}/*!sc*/
data-styled.g2[id="sc-gtsrHT"]{content:"kFWJEY,"}/*!sc*/
.fHUQtx{color:#009900;}/*!sc*/
data-styled.g30[id="sc-cxNHIi"]{content:"fHUQtx,"}/*!sc*/
.hpRDUw{color:#000000;}/*!sc*/
data-styled.g31[id="sc-lmgQwP"]{content:"hpRDUw,"}/*!sc*/
.bYgUJS{color:#268bd2;}/*!sc*/
data-styled.g33[id="sc-giAqHp"]{content:"bYgUJS,"}/*!sc*/
.fDDjHD{color:#770088;}/*!sc*/
data-styled.g35[id="sc-bYwzuL"]{content:"fDDjHD,"}/*!sc*/
.iehvjW{color:#b58900;}/*!sc*/
data-styled.g36[id="sc-kLojOw"]{content:"iehvjW,"}/*!sc*/
</style>
</head><body><div class="content"><p><span></span><a href="/index"><span>Jake Donham</span></a><span> &gt; </span><a href="/blog/index"><span>Technical Difficulties</span></a><span> &gt; How to run Electron on Linux on Docker on Mac</span></p><h1 id="how-to-run-electron-on-linux-on-docker-on-mac"><span>How to run Electron on Linux on Docker on Mac</span></h1><h3 id="2021-02-18"><span><em>2021-02-18</em></span></h3><p><span>My co-Recurser Hazem tried running </span><a href="https://github.com/jaked/programmable-matter" class="sc-gtsrHT kFWJEY"><span>Programmable Matter</span></a><span> on Linux, and it didn&#x27;t work very well (I had previously run it only on my Mac). So the past few days I have been getting it running on Linux on </span><a href="https://www.docker.com/" class="sc-gtsrHT kFWJEY"><span>Docker</span></a><span> in order to fix it. I had not used Docker before so this was an adventure! I learned a lot.</span></p><p><span>Docker lets you run virtual computers (I&#x27;ll call them </span><span><em>guests</em></span><span>, although this is not </span><a href="https://docs.docker.com/glossary/" class="sc-gtsrHT kFWJEY"><span>official Docker terminology</span></a><span>) inside your computer (the </span><span><em>host</em></span><span>), and guests can run different operating systems from the one the host runs. You can use it to develop and test software on other OSes (or different versions of your host OS); or to bundle up a bunch of software packages so users can install and uninstall them all together; or to run programs in a restricted environment so they can&#x27;t damage the host.</span></p><p><span>I have a vague idea how this all works but I still find it extremely magical! Docker seems to be very well put together and everything worked really smoothly for me. Nonetheless I ran into a lot of puzzling stuff and did a whole lot of Googling to get it working. Mostly why this was complicated is that Programmable Matter is based on </span><a href="https://www.electronjs.org/" class="sc-gtsrHT kFWJEY"><span>Electron</span></a><span>, which makes some unusual demands of the operating system it runs on.</span></p><p><span>Here is what I needed to do at a high level:</span></p><ul><li><p><span>learn about Docker. I went through the </span><a href="https://docs.docker.com/get-started/" class="sc-gtsrHT kFWJEY"><span>getting started</span></a><span> tutorial, it was great.</span></p></li><li><p><span>build an </span><span><em>image</em></span><span> containing the base Linux installation and any extra libraries needed to run my app. (To run a guest computer you load an image into a </span><span><em>container</em></span><span>.)</span></p></li><li><p><span>set things up so that the app running on the guest can display a window on my Mac.</span></p></li><li><p><span>figure out some Docker security stuff.</span></p></li><li><p><span>run the app!</span></p></li></ul><h2 id="building-a-docker-image"><span>Building a Docker image</span></h2><p><span>To build an image, you write a </span><span><code>Dockerfile</code></span><span>, which is a script of actions that modify the guest computer&#x27;s storage; when the script finishes, the storage is snapshotted into a file on the host. Here&#x27;s the one I wrote (with explanations interpolated):</span></p><pre class="sc-bdnxRM bOWasK"><code><span class="sc-bYwzuL fDDjHD">FROM</span><span class="sc-lmgQwP hpRDUw"> node:14</span></code></pre><p><span>This line names a base image to start with. Docker has a </span><a href="https://hub.docker.com/" class="sc-gtsrHT kFWJEY"><span>repository of images</span></a><span> of various base operating systems and add-ons. This one is a Debian image with Node.js version 14 installed (see </span><a href="https://hub.docker.com/_/node" class="sc-gtsrHT kFWJEY"><span>https://hub.docker.com/_/node</span></a><span>). There are a bunch of choices here: for example, the sample app in the tutorial uses an image with Node on top of Alpine Linux, which is a lot smaller than Debian. (I picked </span><span><code>node:14</code></span><span> because the smaller ones sounded from the docs like they might not work for me, but I should go back and try it.)</span></p><p><span>From this point on in the </span><span><code>Dockerfile</code></span><span> you can run ordinary shell commands in the context of the guest:</span></p><pre class="sc-bdnxRM bOWasK"><code><span class="sc-cxNHIi fHUQtx"># stuff needed to get Electron to run</span>
RUN <span class="sc-kLojOw iehvjW">apt-get</span> update <span class="sc-lmgQwP hpRDUw">&amp;&amp;</span> <span class="sc-kLojOw iehvjW">apt-get</span> <span class="sc-kLojOw iehvjW">install</span> <span class="sc-lmgQwP hpRDUw">\</span>
    <span class="sc-kLojOw iehvjW">git</span> libx11-xcb1 libxcb-dri3-0 libxtst6 libnss3 libatk-bridge2.0-0 libgtk-3-0 libxss1 libasound2 <span class="sc-lmgQwP hpRDUw">\</span>
    -yq --no-install-suggests --no-install-recommends <span class="sc-lmgQwP hpRDUw">\</span>
    <span class="sc-lmgQwP hpRDUw">&amp;&amp;</span> <span class="sc-kLojOw iehvjW">apt-get</span> clean <span class="sc-lmgQwP hpRDUw">&amp;&amp;</span> <span class="sc-kLojOw iehvjW">rm</span> -rf /var/lib/apt/lists/*</code></pre><p><span>The base images are typically pretty stripped down compared to a normal OS installation. In particular, </span><span><code>node:14</code></span><span> is missing a bunch of libraries that Electron depends on for rendering the display. I found these by trying to start the app, getting an error like</span></p><div style="background-color:#ffc0c0;margin-left:10px;margin-right:10px;padding:10px"><code>libX11-xcb.so.1: cannot open shared object file: No such file or directory</code></div><p><span>searching for the missing library at </span><a href="https://www.debian.org/distrib/packages#search_contents" class="sc-gtsrHT kFWJEY"><span>https://www.debian.org/distrib/packages#search_contents</span></a><span>, and adding the matching package. (</span><span><code>Git</code></span><span> is needed by </span><a href="https://www.electronforge.io/" class="sc-gtsrHT kFWJEY"><span><code>electron-forge</code></span></a><span>, which I&#x27;m using to run my app.)</span></p><pre class="sc-bdnxRM bOWasK"><code><span class="sc-cxNHIi fHUQtx"># Electron doesn&#x27;t like to run as root</span>
<span class="sc-bYwzuL fDDjHD">RUN</span><span class="sc-lmgQwP hpRDUw"> useradd -d /programmable-matter programmable-matter</span>
<span class="sc-bYwzuL fDDjHD">USER</span><span class="sc-lmgQwP hpRDUw"> programmable-matter</span></code></pre><p><span>If you try to run Electron as root you get</span></p><p><span></span><div style="background-color:#ffc0c0;margin-left:10px;margin-right:10px;padding:10px"><code>Running as root without --no-sandbox is not supported.</code></div><span></span></p><p><span>so we need to add a user (more about </span><span><code>--no-sandbox</code></span><span> below). The </span><span><code>USER</code></span><span> command changes to the given user for subsequent commands.</span></p><pre class="sc-bdnxRM bOWasK"><code><span class="sc-bYwzuL fDDjHD">WORKDIR</span><span class="sc-lmgQwP hpRDUw"> /programmable-matter</span>
<span class="sc-bYwzuL fDDjHD">COPY</span><span class="sc-lmgQwP hpRDUw"> . .</span>
<span class="sc-bYwzuL fDDjHD">RUN</span><span class="sc-lmgQwP hpRDUw"> npm install</span>
<span class="sc-bYwzuL fDDjHD">RUN</span><span class="sc-lmgQwP hpRDUw"> npx electron-rebuild</span></code></pre><p><span>The </span><span><code>WORKDIR</code></span><span> command sets the working directory for subsequent commands, then </span><span><code>COPY</code></span><span> copies a file tree containing the app code from the host filesystem to the guest filesystem. This includes </span><span><code>package.json</code></span><span>, so we can run </span><span><code>npm install</code></span><span>. We also run </span><span><code>electron-rebuild</code></span><span> which builds some native code modules to match the installed Electron version. (</span><span><code>Electron-rebuild</code></span><span> is run by </span><span><code>electron-forge</code></span><span> on launch if we don&#x27;t do it here, but that causes a Docker security issue, see below; and also makes startup slower, so I moved it here.)</span></p><pre class="sc-bdnxRM bOWasK"><code><span class="sc-cxNHIi fHUQtx"># Electron needs root for sandboxing</span>
<span class="sc-cxNHIi fHUQtx"># see https://github.com/electron/electron/issues/17972</span>
<span class="sc-bYwzuL fDDjHD">USER</span><span class="sc-lmgQwP hpRDUw"> root</span>
<span class="sc-bYwzuL fDDjHD">RUN</span><span class="sc-lmgQwP hpRDUw"> chown root /programmable-matter/node_modules/electron/dist/chrome-sandbox</span>
<span class="sc-bYwzuL fDDjHD">RUN</span><span class="sc-lmgQwP hpRDUw"> chmod 4755 /programmable-matter/node_modules/electron/dist/chrome-sandbox</span></code></pre><p><span>Without this the app errors out with</span></p><p><span></span><div style="background-color:#ffc0c0;margin-left:10px;margin-right:10px;padding:10px"><code>The SUID sandbox helper binary was found, but is not configured correctly.</code></div><span></span></p><p><span>As far as I understand things: Electron is based on Chromium, which has a fancy </span><a href="http://www.chromium.org/developers/design-documents/multi-process-architecture" class="sc-gtsrHT kFWJEY"><span>multi-process architecture</span></a><span> in which some processes are run with restricted permissions (&quot;sandboxed&quot;). Sandboxing can be done with a Linux kernel facility called &quot;user namespaces&quot;, but this facility is not enabled on some Linux distributions, so there is a workaround using a setuid helper program. However </span><span><code>npm install</code></span><span> can&#x27;t set the setuid bit without root permission, and the Electron package </span><a href="https://github.com/electron/electron/issues/17972" class="sc-gtsrHT kFWJEY"><span>chooses not to ask for it</span></a><span>, so we need to do it explicitly. (I&#x27;m not sure whether user namespaces can be enabled on the Debian base image I started with, but I think it may use an older kernel version and this is a fairly recent feature.)</span></p><pre class="sc-bdnxRM bOWasK"><code><span class="sc-bYwzuL fDDjHD">USER</span><span class="sc-lmgQwP hpRDUw"> programmable-matter</span>
<span class="sc-bYwzuL fDDjHD">CMD</span><span class="sc-lmgQwP hpRDUw"> npm run start</span></code></pre><p><span>Now we are ready to build the image with</span></p><pre class="sc-bdnxRM bOWasK"><code>docker build -t programmable-matter <span class="sc-giAqHp bYgUJS">.</span></code></pre><p><span>and run it with</span></p><pre class="sc-bdnxRM bOWasK"><code>docker run programmable-matter</code></pre><p><span>But we get an error:</span></p><p><span></span><div style="background-color:#ffc0c0;margin-left:10px;margin-right:10px;padding:10px"><code>Failed to move to new namespace: PID namespaces supported, Network namespace supported, but failed: errno = Operation not permitted.</code></div><span> </span></p><h2 id="xquartz-and-display"><span>XQuartz and DISPLAY</span></h2><p><span>I like long specific error messages like this, they are easy to Google. I found </span><a href="https://stackoverflow.com/a/53975412/205191" class="sc-gtsrHT kFWJEY"><span>this</span></a><span>, which suggests either passing the </span><span><code>--no-sandbox</code></span><span> argument or setting up a custom </span><span><code>seccomp</code></span><span> configuration. I was feeling tired and not very interested in setting up a custom configuration for something I had never heard of, so I tried </span><span><code>--no-sandbox</code></span><span>, which got me past the namespace error and on to a new one:</span></p><p><span></span><div style="background-color:#ffc0c0;margin-left:10px;margin-right:10px;padding:10px"><code>The futex facility returned an unexpected error code.</code></div><span></span></p><p><span>Not very helpful—I was expecting this to be hard to Google, but </span><a href="https://github.com/electron/electron/issues/24211" class="sc-gtsrHT kFWJEY"><span>this Electron issue</span></a><span> was the second hit. Turns out I needed to set the </span><span><code>DISPLAY</code></span><span> environment variable so Electron knows where to render its windows, using </span><a href="https://en.wikipedia.org/wiki/X_Window_System" class="sc-gtsrHT kFWJEY"><span>X</span></a><span>, the standard windowing system on Linux.</span></p><p><span>My Mac is running an implementation of the X display server, </span><a href="https://www.xquartz.org/" class="sc-gtsrHT kFWJEY"><span>XQuartz</span></a><span>, which can receive connections from X programs and render their windows. When you&#x27;re running an X client and server on the same computer they normally connect over a Unix socket for performance (and also for security). I tried to mount the X Unix socket from the host to the guest, following </span><a href="https://blog.jessfraz.com/post/docker-containers-on-the-desktop/" class="sc-gtsrHT kFWJEY"><span>this post</span></a><span>, but I got several variations of</span></p><p><span></span><div style="background-color:#ffc0c0;margin-left:10px;margin-right:10px;padding:10px"><code>docker: Error response from daemon: invalid mode: /tmp/.X11-unix</code></div><span></span></p><p><span>It turns out that mounting arbitrary Unix sockets into a container is </span><a href="https://github.com/docker/for-mac/issues/483" class="sc-gtsrHT kFWJEY"><span>not supported on Docker for Mac</span></a><span>. Instead (following these </span><a href="https://gist.github.com/paul-krohn/e45f96181b1cf5e536325d1bdee6c949" class="sc-gtsrHT kFWJEY"><span>instructions</span></a><span>) I set an XQuartz preference to allow connections from network clients, ran </span><span><code>xhost +localhost</code></span><span> to allow connections from </span><span><code>localhost</code></span><span>, and ran </span><span><code>docker</code></span><span> like so:</span></p><pre class="sc-bdnxRM bOWasK"><code>docker run -e <span class="sc-lmgQwP hpRDUw">DISPLAY</span><span class="sc-lmgQwP hpRDUw">=</span>host.docker.internal:0 programmable-matter</code></pre><p><span>It works! The guest OS can reach network ports on the host at </span><span><code>host.docker.internal</code></span><span>, and </span><span><code>-e DISPLAY=</code></span><span> passes the environment variable to the </span><span><code>CMD</code></span><span> in the </span><span><code>Dockerfile</code></span><span>. I also needed to run </span><span><code>xhost +localhost</code></span><span> so XQuartz will accept the connection. This is not secure for general use (XQuartz trusts the IP address of the incoming connection), but it seems OK for local use.</span></p><h2 id="docker-and-seccomp"><span>Docker and seccomp</span></h2><p><span>After a rest on the fainting couch, I decided to try to set up </span><span><code>seccomp</code></span><span> in order to get rid of the </span><span><code>--no-sandbox</code></span><span> argument. I am not sure how much practical value this has, since the whole app is running in a container, but maybe it prevents dangerous access between app processes in the container. In any case </span><span><code>--no-sandbox</code></span><span> seems like an escape-hatch flag that should be avoided. So following </span><a href="https://stackoverflow.com/a/53975412/205191" class="sc-gtsrHT kFWJEY"><span>these instructions</span></a><span> I tried running the container like so:</span></p><pre class="sc-bdnxRM bOWasK"><code>docker run -e <span class="sc-lmgQwP hpRDUw">DISPLAY</span><span class="sc-lmgQwP hpRDUw">=</span>host.docker.internal:0 --security-opt <span class="sc-lmgQwP hpRDUw">seccomp</span><span class="sc-lmgQwP hpRDUw">=</span>chrome.json programmable-matter</code></pre><p><span>where </span><a href="https://github.com/jessfraz/dotfiles/blob/master/etc/docker/seccomp/chrome.json" class="sc-gtsrHT kFWJEY"><span><code>chrome.json</code></span></a><span> is from Jessie Frazelle&#x27;s </span><a href="https://github.com/jessfraz/dotfiles/" class="sc-gtsrHT kFWJEY"><span>dotfiles</span></a><span> (see also </span><a href="https://blog.jessfraz.com/post/how-to-use-new-docker-seccomp-profiles/" class="sc-gtsrHT kFWJEY"><span>how it was made</span></a><span>). As far as I understand things, </span><a href="https://docs.docker.com/engine/security/seccomp/" class="sc-gtsrHT kFWJEY"><span><code>seccomp</code></span></a><span> configures a list of Linux system calls that programs running on the guest are allowed to call, and </span><span><code>chrome.json</code></span><span> includes the namespace calls Chromium uses for sandboxing. But:</span></p><p><span></span><div style="background-color:#ffc0c0;margin-left:10px;margin-right:10px;padding:10px"><code>EPERM: operation not permitted, copyfile &#x27;/programmable-matter/node_modules/nsfw/build/Release/nsfw.node&#x27; -&gt; &#x27;/programmable-matter/node_modules/nsfw/bin/linux-x64-80/nsfw.node&#x27;</code></div><span></span></p><p><span>The file in question is part of a native library I&#x27;m using, </span><a href="https://github.com/Axosoft/nsfw" class="sc-gtsrHT kFWJEY"><span>NSFW</span></a><span>, and the error comes up while </span><span><code>electron-forge</code></span><span> is running </span><span><code>electron-rebuild</code></span><span>. I thought that </span><span><code>copyfile</code></span><span> was the name of a system call so I tried adding it to </span><span><code>chrome.json</code></span><span>, but that didn&#x27;t work. I did find </span><a href="https://man7.org/linux/man-pages/man2/copy_file_range.2.html" class="sc-gtsrHT kFWJEY"><span><code>copy_file_range</code></span></a><span>, however, and adding that one worked! I spent some time digging to find where the string </span><span><code>copyfile</code></span><span> comes from (</span><span><code>electron-forge</code></span><span> calls </span><span><code>electron-rebuild</code></span><span> calls </span><span><code>node-gyp</code></span><span> which I think generates and runs a </span><span><code>Makefile</code></span><span>) but gave up.</span></p><p><span>Finally I realized that </span><span><code>electron-rebuild</code></span><span> can be run at image build time instead of container run time; now the original </span><span><code>chrome.json</code></span><span> works. So I guess there is no </span><span><code>seccomp</code></span><span> restriction at image build time.</span></p><h2 id="the-end"><span>The end</span></h2><p><span>Truly, friends, we live in a time of wonders! Please </span><a href="/blog/mailto%3Ajake%40donham.org"><span>email me</span></a><span> with comments, criticisms, corrections.</span></p></div></body></html>