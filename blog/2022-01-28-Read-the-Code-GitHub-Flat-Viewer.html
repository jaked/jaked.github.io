<html><head><title>Read the Code: GitHub Flat Viewer</title><meta name="twitter:card" content="summary"/><meta name="twitter:site" content="@jakedonham"/><meta name="twitter:creator" content="@jakedonham"/><meta name="twitter:title" content="Read the Code: GitHub Flat Viewer"/><meta name="twitter:description" content="Read the Code: GitHub Flat Viewer"/><style>
body {
  background-color: #eeeeee;
}
.content {
  background-color: white;
  padding-top: 80px;
  padding-bottom: 80px;
  padding-left: 120px;
  padding-right: 120px;
  margin-left: auto;
  margin-right: auto;
  max-width: 700px
}
blockquote { margin-block-end: 2em }
p, ul { font-family: serif; font-size: 19px; line-height: 26px }
code { font-family: monospace; font-size: 14px; }
pre { font-family: monospace; font-size: 14px; }
h1, h2, h3, h4, h5, h6 { font-family: sans-serif }
a:link { text-decoration: none; }
a:visited { color: blue }
a:hover {
  background-color: #eeeeee;
}
hr { border-style: solid }
</style>
<script type='module' src='/blog/2022-01-28-Read-the-Code-GitHub-Flat-Viewer.js'></script>
<style data-styled="true" data-styled-version="5.3.0">.bOWasK{background-color:#f7f7f7;margin-left:10px;margin-right:10px;padding:10px;overflow:auto;}/*!sc*/
data-styled.g1[id="sc-bdnxRM"]{content:"bOWasK,"}/*!sc*/
.kFWJEY:hover{cursor:pointer;}/*!sc*/
data-styled.g2[id="sc-gtsrHT"]{content:"kFWJEY,"}/*!sc*/
.dvHFX{color:#000000;}/*!sc*/
data-styled.g34[id="sc-ezzafa"]{content:"dvHFX,"}/*!sc*/
.fDDjHD{color:#aa1111;}/*!sc*/
data-styled.g35[id="sc-bYwzuL"]{content:"fDDjHD,"}/*!sc*/
.iehvjW{color:#770088;}/*!sc*/
data-styled.g36[id="sc-kLojOw"]{content:"iehvjW,"}/*!sc*/
.hbusih{color:#b58900;}/*!sc*/
data-styled.g37[id="sc-iklJeh"]{content:"hbusih,"}/*!sc*/
.dRsyqq{color:#116644;}/*!sc*/
data-styled.g39[id="sc-hiKfDv"]{content:"dRsyqq,"}/*!sc*/
.lRfdj{color:#221199;}/*!sc*/
data-styled.g41[id="sc-cBoqAE"]{content:"lRfdj,"}/*!sc*/
</style>
</head><body><div class="content"><p><span></span></p><p><span></span><a href="/index"><span>Jake Donham</span></a><span> &gt; </span><a href="/blog/index"><span>Technical Difficulties</span></a><span> &gt; Read the Code: GitHub Flat Viewer</span></p><h1 id="read-the-code-github-flat-viewer"><span>Read the Code: GitHub Flat Viewer</span></h1><h3 id="2022-01-28"><span><em>2022-01-28</em></span></h3><p><span>One way I like to learn new a computer thing—a new library, language, tool, or technique—is to read the code of projects that use it. I don&#x27;t do this enough! I usually start by following a &quot;getting started&quot; tutorial, skimming the documentation, and looking at example code. But often the distance between getting started with a computer thing and using it effectively is very large. So reading the code of a substantial project can be really helpful: it&#x27;s working code with a purpose; you can see how the new thing works and how it fits together with other things. I also like reading project code because I usually learn a lot of things beyond what I set out to learn, like tools and libraries I hadn&#x27;t heard of, or programming styles and idioms.</span></p><p><span>I&#x27;m starting a new job soon at </span><a href="https://next.github.com/" class="sc-gtsrHT kFWJEY"><span>GitHub Next</span></a><span>, so I thought I would read the code of some existing GitHub Next projects to get a sense of how the team works. I started with </span><a href="https://github.com/githubocto/flat-viewer" class="sc-gtsrHT kFWJEY"><span>Flat Viewer</span></a><span>, a browser app that reads flat data files from GitHub via the </span><a href="https://docs.github.com/en/rest" class="sc-gtsrHT kFWJEY"><span>REST API</span></a><span> and displays them in a table interface with sorting and filtering. I think it&#x27;s a pretty straightforward browser app, but I am not a very experienced browser app programmer, so I learned a lot. In what follows I&#x27;m going to focus on the parts that are new to me, so this will be a bit of a hodgepodge, but I hope there&#x27;s something in it that&#x27;s new and/or useful for you.</span></p><p><span>The world of libraries, frameworks, and tools for building browser apps is immense and ever-changing—&quot;best practice&quot; is a destination forever receding into the distance as you approach—so please read this as a description of one way of doing things, that seems to work for a particular purpose, as one person understands it, rather than anything like an authoritative explanation.</span></p><p><span>Flat Viewer is a </span><a href="https://reactjs.org/" class="sc-gtsrHT kFWJEY"><span>React</span></a><span> app written in </span><a href="https://www.typescriptlang.org/" class="sc-gtsrHT kFWJEY"><span>TypeScript</span></a><span>. Good, I feel pretty comfortable with this! Let&#x27;s walk through the components:</span></p><h2 id="app"><span>App</span></h2><p><span>The main component is </span><a href="https://github.com/githubocto/flat-viewer/blob/ea66076452c8f6b62fac5785e55b6137657a5e11/src/App.tsx#L13" class="sc-gtsrHT kFWJEY"><span><code>App</code></span></a><span>, and the main thing it does is route to different views within the app based on the URL path, using </span><a href="https://v5.reactrouter.com/" class="sc-gtsrHT kFWJEY"><span>React Router</span></a><span>. In a single-page React app, navigating to a view doesn&#x27;t interact with the browser&#x27;s URL bar: history is not recorded, and you can&#x27;t get back to a view by copying and pasting its URL. React Router parses the URL and routes to a matching view; navigating to a view updates the URL (and records it in history). This works using a pattern-matching syntax inside of React JSX tags, like so:</span></p><pre class="sc-bdnxRM bOWasK"><code><span class="sc-ezzafa dvHFX">&lt;</span>Router<span class="sc-ezzafa dvHFX">&gt;</span>
  <span class="sc-ezzafa dvHFX">&lt;</span>Switch<span class="sc-ezzafa dvHFX">&gt;</span>
    <span class="sc-ezzafa dvHFX">&lt;</span>Route exact path<span class="sc-ezzafa dvHFX">=</span><span class="sc-bYwzuL fDDjHD">&quot;/&quot;</span> component<span class="sc-ezzafa dvHFX">=</span><span class="sc-ezzafa dvHFX">{</span>Home<span class="sc-ezzafa dvHFX">}</span> <span class="sc-ezzafa dvHFX">/</span><span class="sc-ezzafa dvHFX">&gt;</span>
    <span class="sc-ezzafa dvHFX">&lt;</span>Route exact path<span class="sc-ezzafa dvHFX">=</span><span class="sc-bYwzuL fDDjHD">&quot;/:org/&quot;</span> component<span class="sc-ezzafa dvHFX">=</span><span class="sc-ezzafa dvHFX">{</span>OrgListing<span class="sc-ezzafa dvHFX">}</span> <span class="sc-ezzafa dvHFX">/</span><span class="sc-ezzafa dvHFX">&gt;</span>
    <span class="sc-ezzafa dvHFX">&lt;</span>Route path<span class="sc-ezzafa dvHFX">=</span><span class="sc-bYwzuL fDDjHD">&quot;/:owner/:name&quot;</span> component<span class="sc-ezzafa dvHFX">=</span><span class="sc-ezzafa dvHFX">{</span>RepoDetail<span class="sc-ezzafa dvHFX">}</span> <span class="sc-ezzafa dvHFX">/</span><span class="sc-ezzafa dvHFX">&gt;</span>
  <span class="sc-ezzafa dvHFX">&lt;</span><span class="sc-ezzafa dvHFX">/</span>Switch<span class="sc-ezzafa dvHFX">&gt;</span>
<span class="sc-ezzafa dvHFX">&lt;</span><span class="sc-ezzafa dvHFX">/</span>Router<span class="sc-ezzafa dvHFX">&gt;</span></code></pre><p><span>An empty path </span><a href="https://flatgithub.com/" class="sc-gtsrHT kFWJEY"><span>/</span></a><span> routes to the </span><span><code>Home</code></span><span> component; a one-segment path like </span><a href="https://flatgithub.com/githubocto/" class="sc-gtsrHT kFWJEY"><span><code>/githubocto/</code></span></a><span> routes to the </span><span><code>OrgListing</code></span><span> component; a two-segment path like </span><a href="https://flatgithub.com/githubocto/flat-demo-bitcoin-price" class="sc-gtsrHT kFWJEY"><span><code>/githubocto/flat-demo-bitcoin-price</code></span></a><span> routes to the </span><span><code>RepoDetail</code></span><span> component.</span></p><p><span>There are a few other things going on in </span><span><code>App</code></span><span>:</span></p><ul><li><p><span>show a progress bar while data is being fetched using </span><a href="https://ricostacruz.com/nprogress/" class="sc-gtsrHT kFWJEY"><span>NProgress</span></a><span></span></p></li><li><p><span>set up a React context for </span><a href="https://react-query.tanstack.com/" class="sc-gtsrHT kFWJEY"><span><code>react-query</code></span></a><span> for reading data from the GitHub API (this is actually one level outside </span><span><code>App</code></span><span> in </span><span><code>main.tsx</code></span><span>, so the progress bar in </span><span><code>App</code></span><span> can use it)</span></p></li><li><p><span>set up a context for </span><a href="https://github.com/tizmagik/react-head" class="sc-gtsrHT kFWJEY"><span><code>react-head</code></span></a><span>, so view components can set the page title with a local </span><span><code>&lt;Title&gt;</code></span><span> tag (instead of twiddling </span><span><code>document.title</code></span><span>)</span></p></li><li><p><span>set up a context for </span><a href="https://github.com/pbeshai/use-query-params" class="sc-gtsrHT kFWJEY"><span><code>use-query-params</code></span></a><span>, which is used to store component state in query params (so browser history and copying/pasting the URL works for that state as well as view navigation; more on this below)</span></p></li></ul><h2 id="home-and-repoform"><span>Home and RepoForm</span></h2><p><span>The </span><a href="https://github.com/githubocto/flat-viewer/blob/ea66076452c8f6b62fac5785e55b6137657a5e11/src/components/home.tsx#L5" class="sc-gtsrHT kFWJEY"><span><code>Home</code></span></a><span> component just adds some styling around </span><a href="https://github.com/githubocto/flat-viewer/blob/ea66076452c8f6b62fac5785e55b6137657a5e11/src/components/repo-form.tsx#L102" class="sc-gtsrHT kFWJEY"><span><code>RepoForm</code></span></a><span>, which shows a form for filling in a GitHub account and repo. There are several interesting things going on in </span><span><code>RepoForm</code></span><span>:</span></p><ul><li><p><span>the form is rendered using </span><a href="https://formik.org/" class="sc-gtsrHT kFWJEY"><span>Formik</span></a><span>, which keeps track of the state of field values, validates the values, and prevents submitting the form if any values are invalid.</span></p></li><li><p><span>field values are validated using </span><a href="https://github.com/jquense/yup" class="sc-gtsrHT kFWJEY"><span><code>yup</code></span></a><span>, which takes a schema describing expected values, like</span></p><pre class="sc-bdnxRM bOWasK"><code><span class="sc-kLojOw iehvjW">const</span> validationSchema <span class="sc-ezzafa dvHFX">=</span> <span class="sc-iklJeh hbusih">object</span><span class="sc-ezzafa dvHFX">(</span><span class="sc-ezzafa dvHFX">)</span><span class="sc-ezzafa dvHFX">.</span><span class="sc-iklJeh hbusih">shape</span><span class="sc-ezzafa dvHFX">(</span><span class="sc-ezzafa dvHFX">{</span>
  owner<span class="sc-ezzafa dvHFX">:</span> <span class="sc-iklJeh hbusih">string</span><span class="sc-ezzafa dvHFX">(</span><span class="sc-ezzafa dvHFX">)</span><span class="sc-ezzafa dvHFX">.</span><span class="sc-iklJeh hbusih">required</span><span class="sc-ezzafa dvHFX">(</span><span class="sc-bYwzuL fDDjHD">&quot;Please enter a repository owner&quot;</span><span class="sc-ezzafa dvHFX">)</span><span class="sc-ezzafa dvHFX">,</span>
  name<span class="sc-ezzafa dvHFX">:</span> <span class="sc-iklJeh hbusih">string</span><span class="sc-ezzafa dvHFX">(</span><span class="sc-ezzafa dvHFX">)</span><span class="sc-ezzafa dvHFX">.</span><span class="sc-iklJeh hbusih">optional</span><span class="sc-ezzafa dvHFX">(</span><span class="sc-ezzafa dvHFX">)</span><span class="sc-ezzafa dvHFX">,</span>
<span class="sc-ezzafa dvHFX">}</span><span class="sc-ezzafa dvHFX">)</span><span class="sc-ezzafa dvHFX">;</span></code></pre><p><span>It&#x27;s integrated with Formik so you can pass the schema directly into the </span><a href="https://formik.org/docs/api/formik" class="sc-gtsrHT kFWJEY"><span><code>&lt;Formik&gt;</code></span></a><span> tag.</span></p></li><li><p><span>submitting the form adds a new path to the browser history using React Router&#x27;s </span><a href="https://v5.reactrouter.com/web/api/Hooks/usehistory" class="sc-gtsrHT kFWJEY"><span><code>useHistory</code></span></a><span> API; this causes the &lt;</span><span><code>Router&gt;</code></span><span> component in </span><span><code>Home</code></span><span> to re-render, changing the view. (</span><span><code>RepoForm</code></span><span> also uses </span><a href="https://v5.reactrouter.com/web/api/Link" class="sc-gtsrHT kFWJEY"><span><code>Link</code></span></a><span> to link to an example repo, which does the same thing.)</span></p></li><li><p><span>fields are styled differently when they are invalid; this is handled using </span><a href="https://github.com/jorgebucaran/classcat" class="sc-gtsrHT kFWJEY"><span><code>classcat</code></span></a><span>, which builds a string of CSS class names from an object mapping names to flags. (More below on styling components.)</span></p></li></ul><p><span>There&#x27;s always a tradeoff between calling out to a dependency and writing the code by hand—I would probably write something simple like this by hand (keep track of field values with </span><a href="https://reactjs.org/docs/hooks-reference.html#usestate" class="sc-gtsrHT kFWJEY"><span><code>React.useState</code></span></a><span> and validate them inline). But I can see that for a big form with intricate validation, using Formik and </span><span><code>yup</code></span><span> would be much easier; and if they are in your toolbox already it&#x27;s easier to use them even for simple things.</span></p><h2 id="orglisting"><span>OrgListing</span></h2><p><span>The </span><a href="https://github.com/githubocto/flat-viewer/blob/ea66076452c8f6b62fac5785e55b6137657a5e11/src/components/org-listing.tsx#L58" class="sc-gtsrHT kFWJEY"><span><code>OrgListing</code></span></a><span> component displays a list of repos from a GitHub account. The list of repos is queried from the GitHub REST API using </span><a href="https://elbywan.github.io/wretch/" class="sc-gtsrHT kFWJEY"><span><code>wretch</code></span></a><span> and </span><a href="https://react-query.tanstack.com/" class="sc-gtsrHT kFWJEY"><span>React Query</span></a><span>.</span></p><p><span><code>Wretch</code></span><span> is a wrapper around the browser built-in </span><a href="https://developer.mozilla.org/en-US/docs/Web/API/fetch" class="sc-gtsrHT kFWJEY"><span><code>fetch</code></span></a><span> function (which makes an HTTP request and returns a </span><span><code>Promise</code></span><span> of the result). It replaces </span><span><code>fetch</code></span><span>&#x27;s &quot;big bag of options&quot;-style interface with a &quot;builder&quot;-style interface, and provides some prebuilt handlers for HTTP-level error responses and for decoding response bodies. Here&#x27;s the </span><span><code>wretch</code></span><span> call to get a list of repos (see </span><a href="https://github.com/githubocto/flat-viewer/blob/ea66076452c8f6b62fac5785e55b6137657a5e11/src/api/index.ts#L286" class="sc-gtsrHT kFWJEY"><span><code>fetchOrgRepos</code></span></a><span>):</span></p><pre class="sc-bdnxRM bOWasK"><code>githubWretch
  <span class="sc-ezzafa dvHFX">.</span><span class="sc-iklJeh hbusih">url</span><span class="sc-ezzafa dvHFX">(</span><span class="sc-ezzafa dvHFX">`</span><span class="sc-bYwzuL fDDjHD">/search/repositories</span><span class="sc-ezzafa dvHFX">`</span><span class="sc-ezzafa dvHFX">)</span>
  <span class="sc-ezzafa dvHFX">.</span><span class="sc-iklJeh hbusih">query</span><span class="sc-ezzafa dvHFX">(</span><span class="sc-ezzafa dvHFX">{</span> q<span class="sc-ezzafa dvHFX">:</span> <span class="sc-ezzafa dvHFX">`</span><span class="sc-bYwzuL fDDjHD">topic:flat-data org:</span><span class="sc-ezzafa dvHFX">${</span><span class="sc-ezzafa dvHFX">orgName</span><span class="sc-ezzafa dvHFX">}</span><span class="sc-ezzafa dvHFX">`</span><span class="sc-ezzafa dvHFX">,</span> per_page<span class="sc-ezzafa dvHFX">:</span> <span class="sc-hiKfDv dRsyqq">100</span> <span class="sc-ezzafa dvHFX">}</span><span class="sc-ezzafa dvHFX">)</span>
  <span class="sc-ezzafa dvHFX">.</span><span class="sc-iklJeh hbusih">get</span><span class="sc-ezzafa dvHFX">(</span><span class="sc-ezzafa dvHFX">)</span>
  <span class="sc-ezzafa dvHFX">.</span><span class="sc-iklJeh hbusih">json</span><span class="sc-ezzafa dvHFX">(</span><span class="sc-ezzafa dvHFX">)</span><span class="sc-ezzafa dvHFX">;</span></code></pre><p><span>It calls the API (at </span><span><code>https://api.github.com</code></span><span>; this is pre-configured in </span><span><code>githubWretch</code></span><span>) with the given path and query params (see the </span><a href="https://docs.github.com/en/rest/reference/search#search-repositories" class="sc-gtsrHT kFWJEY"><span>API docs</span></a><span>), then decodes a successful response as JSON. (Note that the search matches only repos tagged </span><span><code>flat-data</code></span><span>.)</span></p><p><span>React rendering is basically synchronous, but </span><span><code>wretch</code></span><span> returns an asynchronous </span><span><code>Promise</code></span><span>. This is where React Query comes in: it keeps track of the state of a query—succeeded (with some value), failed (with some error), or waiting—and rerenders components that depend on the query when the state changes (e.g. the </span><span><code>Promise</code></span><span> resolves). To query the list of repos, the </span><span><code>wretch</code></span><span> query above is wrapped in a </span><a href="https://react-query.tanstack.com/reference/useQuery" class="sc-gtsrHT kFWJEY"><span><code>useQuery</code></span></a><span> hook (in </span><a href="https://github.com/githubocto/flat-viewer/blob/ea66076452c8f6b62fac5785e55b6137657a5e11/src/hooks/index.ts#L75" class="sc-gtsrHT kFWJEY"><span><code>useOrgFlatRepos</code></span></a><span>):</span></p><pre class="sc-bdnxRM bOWasK"><code><span class="sc-iklJeh hbusih">useQuery</span><span class="sc-ezzafa dvHFX">(</span>
  <span class="sc-ezzafa dvHFX">[</span><span class="sc-bYwzuL fDDjHD">&quot;org&quot;</span><span class="sc-ezzafa dvHFX">,</span> orgName<span class="sc-ezzafa dvHFX">]</span><span class="sc-ezzafa dvHFX">,</span>
  <span class="sc-ezzafa dvHFX">(</span><span class="sc-ezzafa dvHFX">)</span> <span class="sc-ezzafa dvHFX">=&gt;</span> <span class="sc-iklJeh hbusih">fetchOrgRepos</span><span class="sc-ezzafa dvHFX">(</span>orgName<span class="sc-ezzafa dvHFX">)</span><span class="sc-ezzafa dvHFX">,</span>
  <span class="sc-ezzafa dvHFX">{</span> retry<span class="sc-ezzafa dvHFX">:</span> <span class="sc-cBoqAE lRfdj">false</span><span class="sc-ezzafa dvHFX">,</span> refetchOnWindowFocus<span class="sc-ezzafa dvHFX">:</span> <span class="sc-cBoqAE lRfdj">false</span> <span class="sc-ezzafa dvHFX">}</span>
<span class="sc-ezzafa dvHFX">)</span></code></pre><p><span>The return value of </span><span><code>useQuery</code></span><span> includes a </span><span><code>status</code></span><span> field of type </span><span><code>&quot;success&quot; | &quot;error&quot; | &quot;loading&quot;</code></span><span>; depending on </span><span><code>status</code></span><span> it has additional fields describing the returned value or error. </span><span><code>OrgListing</code></span><span> renders an appropriate component (</span><span><code>RepoListing</code></span><span>, </span><span><code>ErrorState</code></span><span>, or </span><span><code>Spinner</code></span><span>) depending on </span><span><code>status</code></span><span>. </span><a href="https://github.com/githubocto/flat-viewer/blob/ea66076452c8f6b62fac5785e55b6137657a5e11/src/components/org-listing.tsx#L20" class="sc-gtsrHT kFWJEY"><span><code>RepoListing</code></span></a><span> renders a list of repos, each with a React Router </span><span><code>Link</code></span><span> to navigate to the </span><span><code>RepoDetail</code></span><span> view.</span></p><p><span>The arguments to </span><span><code>useQuery</code></span><span> are a label (used for caching and deduplicating queries), a </span><span><code>Promise</code></span><span>-returning function that makes the underlying query (you can use any library you like), and some options controlling when the query should be retried or refetched (by default, focusing away then returning to the browser refetches the query).</span></p><h2 id="repodetail"><span>RepoDetail</span></h2><p><span>The </span><a href="https://github.com/githubocto/flat-viewer/blob/ea66076452c8f6b62fac5785e55b6137657a5e11/src/components/repo-detail.tsx#L36" class="sc-gtsrHT kFWJEY"><span><code>RepoDetail</code></span></a><span> component displays controls to select a data file and version from a repo, and a table view of the selected data. By default the first file (having an appropriate format) in the repo and latest version are shown.</span></p><p><span>The state representing the selected data file and version is tracked with </span><a href="https://github.com/pbeshai/use-query-params" class="sc-gtsrHT kFWJEY"><span><code>use-query-params</code></span></a><span>. This provides a </span><a href="https://github.com/pbeshai/use-query-params/tree/master/packages/use-query-params#usequeryparam" class="sc-gtsrHT kFWJEY"><span><code>useQueryParam</code></span></a><span> hook that works like </span><span><code>React.useState</code></span><span>:</span></p><pre class="sc-bdnxRM bOWasK"><code><span class="sc-kLojOw iehvjW">const</span> <span class="sc-ezzafa dvHFX">[</span>filename<span class="sc-ezzafa dvHFX">,</span> setFilename<span class="sc-ezzafa dvHFX">]</span> <span class="sc-ezzafa dvHFX">=</span> <span class="sc-iklJeh hbusih">useQueryParam</span><span class="sc-ezzafa dvHFX">(</span><span class="sc-bYwzuL fDDjHD">&quot;filename&quot;</span><span class="sc-ezzafa dvHFX">,</span> StringParam<span class="sc-ezzafa dvHFX">)</span><span class="sc-ezzafa dvHFX">;</span>
<span class="sc-kLojOw iehvjW">const</span> <span class="sc-ezzafa dvHFX">[</span>selectedSha<span class="sc-ezzafa dvHFX">,</span> setSelectedSha<span class="sc-ezzafa dvHFX">]</span> <span class="sc-ezzafa dvHFX">=</span> <span class="sc-iklJeh hbusih">useQueryParam</span><span class="sc-ezzafa dvHFX">(</span><span class="sc-bYwzuL fDDjHD">&quot;sha&quot;</span><span class="sc-ezzafa dvHFX">,</span> StringParam<span class="sc-ezzafa dvHFX">)</span><span class="sc-ezzafa dvHFX">;</span></code></pre><p><span>but serializes the state value (</span><span><code>StringParam</code></span><span> specifies how to serialize it) and stores it in URL query params. It integrates with React Router; updating a state variable (e.g. calling </span><span><code>setFilename</code></span><span>) causes a navigation, so the state is restored if you copy/paste the URL or press the back button. Nice! There is a lot I don&#x27;t understand about how React Router and </span><span><code>use-query-params</code></span><span> work under the hood—it would be worth reading this code, but not today.</span></p><p><span>When </span><span><code>RepoDetail</code></span><span> renders, it first queries a list of files in the repo (with </span><a href="https://github.com/githubocto/flat-viewer/blob/ea66076452c8f6b62fac5785e55b6137657a5e11/src/hooks/index.ts#L60" class="sc-gtsrHT kFWJEY"><span><code>useGetFiles</code></span></a><span> and </span><a href="https://github.com/githubocto/flat-viewer/blob/ea66076452c8f6b62fac5785e55b6137657a5e11/src/api/index.ts#L97" class="sc-gtsrHT kFWJEY"><span><code>fetchFilesFromRepo</code></span></a><span>; see the </span><a href="https://docs.github.com/en/rest/reference/git#get-a-tree" class="sc-gtsrHT kFWJEY"><span>API docs</span></a><span>) and sets </span><span><code>filename</code></span><span> to the first valid filename. Next it queries the list of commits for the file (with </span><a href="https://github.com/githubocto/flat-viewer/blob/ea66076452c8f6b62fac5785e55b6137657a5e11/src/api/index.ts#L97" class="sc-gtsrHT kFWJEY"><span><code>useCommits</code></span></a><span> and </span><a href="https://github.com/githubocto/flat-viewer/blob/ea66076452c8f6b62fac5785e55b6137657a5e11/src/api/index.ts#L97" class="sc-gtsrHT kFWJEY"><span><code>fetchCommits</code></span></a><span>; see the </span><a href="https://docs.github.com/en/rest/reference/git#get-a-commit" class="sc-gtsrHT kFWJEY"><span>API docs</span></a><span>) and sets </span><span><code>selectedSha</code></span><span> to the hash of the latest commit. React Query has a nice way to chain asynchronous queries: </span><span><code>useQuery</code></span><span> supports an </span><span><code>enabled</code></span><span> flag, which the </span><span><code>useCommits</code></span><span> query sets only when the </span><span><code>useGetFiles</code></span><span> query has completed successfully.</span></p><p><span><code>UseCommits</code></span><span> / </span><span><code>fetchCommits</code></span><span> refer to the type of the API response using </span><span><code>Endpoints</code></span><span> from </span><a href="https://github.com/octokit/types.ts#readme" class="sc-gtsrHT kFWJEY"><span><code>@octokit/types</code></span></a><span>:</span></p><pre class="sc-bdnxRM bOWasK"><code><span class="sc-kLojOw iehvjW">type</span> <span class="sc-ezzafa dvHFX">listCommitsResponse</span> <span class="sc-ezzafa dvHFX">=</span>
  Endpoints<span class="sc-ezzafa dvHFX">[</span><span class="sc-bYwzuL fDDjHD">&quot;GET /repos/{owner}/{repo}/commits&quot;</span><span class="sc-ezzafa dvHFX">]</span><span class="sc-ezzafa dvHFX">[</span><span class="sc-bYwzuL fDDjHD">&quot;response&quot;</span><span class="sc-ezzafa dvHFX">]</span><span class="sc-ezzafa dvHFX">;</span></code></pre><p><span>This is very cool! Apparently the types are </span><a href="https://github.blog/2020-04-09-from-48k-lines-of-code-to-10-the-story-of-githubs-javascript-sdk/" class="sc-gtsrHT kFWJEY"><span>scraped from the API docs</span></a><span>. It looks like Octokit doesn&#x27;t have full types for the search API (used in </span><span><code>OrgListing</code></span><span>), so those types are written out explicitly. (I wonder why Flat Viewer doesn&#x27;t use the </span><a href="https://github.com/octokit/rest.js" class="sc-gtsrHT kFWJEY"><span>Octokit client</span></a><span>.)</span></p><p><span>Commits of data files created by </span><a href="https://github.com/marketplace/actions/flat-data" class="sc-gtsrHT kFWJEY"><span>Flat Action</span></a><span> contain the URL of the data source (see </span><a href="https://github.com/githubocto/flat-demo-bitcoin-price/commit/884305594b4416a66fef3404f9bb95c668f194d0" class="sc-gtsrHT kFWJEY"><span>example</span></a><span>); </span><span><code>RepoDetail</code></span><span> parses it out (with </span><a href="https://github.com/githubocto/flat-viewer/blob/ea66076452c8f6b62fac5785e55b6137657a5e11/src/lib/index.ts#L15" class="sc-gtsrHT kFWJEY"><span><code>parseFlatCommitMessage</code></span></a><span>) in order to display a link.</span></p><p><span>Finally, </span><span><code>RepoDetail</code></span><span> renders its controls (with components to show file and version pickers) and the data file itself (using </span><span><code>JSONDetail</code></span><span>). There&#x27;s also a &quot;toast&quot; component for displaying error messages, and a &quot;disclosure&quot; component that makes the controls hideable on smaller displays; I didn&#x27;t dig into the details.</span></p><h2 id="jsondetail"><span>JSONDetail</span></h2><p><span>The </span><a href="https://github.com/githubocto/flat-viewer/blob/ea66076452c8f6b62fac5785e55b6137657a5e11/src/components/json-detail-container.tsx#L23" class="sc-gtsrHT kFWJEY"><span><code>JSONDetail</code></span></a><span> component queries the contents of a data file (with </span><a href="https://github.com/githubocto/flat-viewer/blob/ea66076452c8f6b62fac5785e55b6137657a5e11/src/hooks/index.ts#L37" class="sc-gtsrHT kFWJEY"><span><code>useDataFile</code></span></a><span> and </span><a href="https://github.com/githubocto/flat-viewer/blob/ea66076452c8f6b62fac5785e55b6137657a5e11/src/api/index.ts#L142" class="sc-gtsrHT kFWJEY"><span><code>fetchDataFile</code></span></a><span>) and displays the contents using </span><a href="https://github.com/githubocto/flat-ui" class="sc-gtsrHT kFWJEY"><span><code>flat-ui</code></span></a><span>. It also displays a picker for keys within the file—I guess it handles JSON files with a top-level object containing multiple arrays? </span><span><code>FetchDataFile</code></span><span> parses the file as CSV, TSV, YAML, or JSON based on the file extension (using </span><a href="https://github.com/d3/d3-dsv" class="sc-gtsrHT kFWJEY"><span><code>d3-dsv</code></span></a><span> and </span><a href="https://eemeli.org/yaml/v1/#yaml" class="sc-gtsrHT kFWJEY"><span><code>yaml</code></span></a><span>), and has some special handling for </span><a href="https://geojson.org/" class="sc-gtsrHT kFWJEY"><span>GeoJSON</span></a><span> / </span><a href="https://github.com/topojson/topojson" class="sc-gtsrHT kFWJEY"><span>TopoJSON</span></a><span> files.</span></p><p><span><code>Flat-ui</code></span><span> has controls for filtering and sorting data, but it doesn&#x27;t maintain its own control state; </span><span><code>JSONDetail</code></span><span> passes props for the control state and an </span><span><code>onChange</code></span><span> callback, and uses </span><span><code>use-query-params</code></span><span> to track the state in the URL:</span></p><pre class="sc-bdnxRM bOWasK"><code><span class="sc-kLojOw iehvjW">const</span> <span class="sc-ezzafa dvHFX">[</span>query<span class="sc-ezzafa dvHFX">,</span> setQuery<span class="sc-ezzafa dvHFX">]</span> <span class="sc-ezzafa dvHFX">=</span> <span class="sc-iklJeh hbusih">useQueryParams</span><span class="sc-ezzafa dvHFX">(</span><span class="sc-ezzafa dvHFX">{</span>
  tab<span class="sc-ezzafa dvHFX">:</span> StringParam<span class="sc-ezzafa dvHFX">,</span>
  stickyColumnName<span class="sc-ezzafa dvHFX">:</span> StringParam<span class="sc-ezzafa dvHFX">,</span>
  sort<span class="sc-ezzafa dvHFX">:</span> StringParam<span class="sc-ezzafa dvHFX">,</span>
  filters<span class="sc-ezzafa dvHFX">:</span> StringParam<span class="sc-ezzafa dvHFX">,</span>
<span class="sc-ezzafa dvHFX">}</span><span class="sc-ezzafa dvHFX">)</span><span class="sc-ezzafa dvHFX">;</span></code></pre><p><span>You pass </span><a href="https://github.com/pbeshai/use-query-params/tree/master/packages/use-query-params#usequeryparams-1" class="sc-gtsrHT kFWJEY"><span><code>useQueryParams</code></span></a><span> an object of serializers (the keys are used as param names), and you can pass a partial object to the setter if you want to set only some fields. (There&#x27;s a </span><a href="https://github.com/pbeshai/use-query-params/blob/master/packages/serialize-query-params/src/types.ts#L37" class="sc-gtsrHT kFWJEY"><span>nice use of type-level programming</span></a><span> to give </span><span><code>query</code></span><span> / </span><span><code>setQuery</code></span><span> the appropriate types based on the serializers.)</span></p><p><span>There is a lot of cool stuff going on in </span><span><code>flat-ui</code></span><span> and I would like to read that code some time.</span></p><h2 id="styling-with-tailwind"><span>Styling with Tailwind</span></h2><p><span>All these components are styled with </span><a href="https://tailwindcss.com/" class="sc-gtsrHT kFWJEY"><span>Tailwind CSS</span></a><span>, so there are lots of class names sprinkled all over the place. I found this very mysterious! Here&#x27;s what the Tailwind </span><a href="https://tailwindcss.com/docs/utility-first" class="sc-gtsrHT kFWJEY"><span>docs</span></a><span> have to say about it:</span></p><blockquote><p><span>Now I know what you’re thinking, “this is an atrocity, what a horrible mess!” and you’re right, it’s kind of ugly. In fact it’s just about impossible to think this is a good idea the first time you see it [...]</span></p></blockquote><p><span>I really appreciate honest documentation!</span></p><p><span>As far as I understand the pitch: the traditional way to do CSS is to write &quot;semantic&quot; classes that describe the style for a particular component in the app, then use the class name whenever that component appears. The Tailwind way is to use &quot;utility&quot; classes that describe particular CSS attributes, and string together the ones you need when you need them. This might cost some duplication (similar components might use a similar set of utility classes), but saves the pain of writing and maintaining a hairy CSS file.</span></p><p><span>I&#x27;ve used </span><a href="https://styled-components.com/" class="sc-gtsrHT kFWJEY"><span><code>styled-components</code></span></a><span>, which is a different way to avoid writing and maintaining a hairy CSS file, so this makes sense to me; but it&#x27;s a whole other language to learn. It would be cool if you could hover a Tailwind class in VS Code and see what it actually means... </span><a href="https://marketplace.visualstudio.com/items?itemName=bradlc.vscode-tailwindcss" class="sc-gtsrHT kFWJEY"><span>oh look</span></a><span>.</span></p><h2 id="thats-it"><span>That&#x27;s it!</span></h2><p><span>Please </span><a href="/blog/mailto%3Ajake%40donham.org"><span>email me</span></a><span> with comments, criticisms, or corrections.</span></p></div></body></html>