<html><head><title>Jest and Typescript</title><style>
body {
  background-color: #eeeeee;
}
.content {
  background-color: white;
  padding-top: 80px;
  padding-bottom: 80px;
  padding-left: 120px;
  padding-right: 120px;
  margin-left: auto;
  margin-right: auto;
  max-width: 800px
}
blockquote { margin-block-end: 2em }
p, ul { font-family: serif; font-size: 19px; line-height: 26px }
code { font-family: monospace; font-size: 14px; }
pre { font-family: monospace; font-size: 14px; }
h1, h2, h3, h4, h5, h6 { font-family: sans-serif }
a:link { text-decoration: none; }
a:visited { color: blue }
a:hover {
  background-color: #eeeeee;
}
hr { border-style: solid }
</style><script type='module' src='/gleanings/Jest and Typescript.js'></script></head><body><div class="content"><p><span></span><a href="/index"><span>Jake Donham</span></a><span> &gt; </span><a href="/gleanings"><span>Gleanings</span></a><span>  &gt; Jest and Typescript</span></p><h1><span>Jest and Typescript</span></h1><p><span>I&#x27;ve found it difficult to get Jest working smoothly with Typescript. Here are some setups I&#x27;ve tried:</span></p><h2><span>Ts-jest</span></h2><p><span></span><a href="https://kulshekhar.github.io/ts-jest/" class="sc-bdnxRM erVzkJ"><span><code>ts-jest</code></span></a><span> is a Jest transformer that runs the actual Typescript compiler. It functions well and (of course) supports all of Typescript. But it can be unacceptably slow on a large project (this seems to be an </span><a href="https://github.com/kulshekhar/ts-jest/issues/1115" class="sc-bdnxRM erVzkJ"><span>ongoing issue</span></a><span>). It&#x27;s especially frustrating because the standalone Typescript compiler (</span><span><code>tsc --watch</code></span><span>) is able to compile the changes quickly, and I have it running all the time anyway.</span></p><h2><span>Esbuild-jest</span></h2><p><span></span><a href="https://github.com/aelbore/esbuild-jest" class="sc-bdnxRM erVzkJ"><span><code>esbuild-jest</code></span></a><span> is a Jest transformer that calls </span><a href="https://esbuild.github.io/" class="sc-bdnxRM erVzkJ"><span><code>esbuild</code></span></a><span>. It is very fast, but it has some </span><a href="https://github.com/aelbore/esbuild-jest/issues/21" class="sc-bdnxRM erVzkJ"><span>weird bugs</span></a><span>, it doesn&#x27;t seem to return source maps correctly (?), and it doesn&#x27;t seem to be under active development.</span></p><h2><span>Babel</span></h2><p><span>The standard way to transform Typescript for Jest is to use </span><a href="https://jestjs.io/docs/getting-started#using-typescript" class="sc-bdnxRM erVzkJ"><span>Babel</span></a><span>. (I can&#x27;t remember if I tried this.)</span></p><h2><span>Sucrase</span></h2><p><span></span><a href="https://sucrase.io/" class="sc-bdnxRM erVzkJ"><span><code>sucrase</code></span></a><span> is a &quot;super-fast Babel alternative&quot; that can be used as a Jest transformer (?). (I haven&#x27;t tried it.)</span></p><h2><span>Transformer that returns </span><span><code>tsc</code></span><span>-compiled files</span></h2><p><span>Here is a transformer I hacked up that returns the corresponding </span><span><code>tsc</code></span><span>-compiled file. It&#x27;s fast when </span><span><code>tsc</code></span><span> is fast, but I am not sure how reliable it is. Jest and </span><span><code>tsc</code></span><span> both watch the filesystem, so </span><span><code>tsc</code></span><span> may not have finished by the time Jest runs the transformer. And I don&#x27;t know what happens if you change a file that a test depends onâ€”is the transformer called for the test file?</span></p><pre class="prism-code language-typescript" style="color:#000000;background-color:#f7f7f7;font-family:Monaco, monospace;font-size:14px;margin-left:10px;margin-right:10px;padding:10px"><div class="token-line" style="color:#000000;font-family:Monaco, monospace;font-size:14px"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#000000;font-family:Monaco, monospace;font-size:14px"><span class="token plain"></span><span class="token keyword" style="color:#770088">const</span><span class="token plain"> path </span><span class="token operator" style="color:#000000">=</span><span class="token plain"> </span><span class="token keyword" style="color:#770088">require</span><span class="token punctuation" style="color:#000000">(</span><span class="token string" style="color:#aa1111">&#x27;path&#x27;</span><span class="token punctuation" style="color:#000000">)</span><span class="token punctuation" style="color:#000000">;</span><span class="token plain"></span></div><div class="token-line" style="color:#000000;font-family:Monaco, monospace;font-size:14px"><span class="token plain"></span><span class="token keyword" style="color:#770088">const</span><span class="token plain"> fs </span><span class="token operator" style="color:#000000">=</span><span class="token plain"> </span><span class="token keyword" style="color:#770088">require</span><span class="token punctuation" style="color:#000000">(</span><span class="token string" style="color:#aa1111">&#x27;fs&#x27;</span><span class="token punctuation" style="color:#000000">)</span><span class="token punctuation" style="color:#000000">;</span><span class="token plain"></span></div><div class="token-line" style="color:#000000;font-family:Monaco, monospace;font-size:14px"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#000000;font-family:Monaco, monospace;font-size:14px"><span class="token plain"></span><span class="token comment" style="color:#009900">// we&#x27;re already running tsc --watch</span><span class="token plain"></span></div><div class="token-line" style="color:#000000;font-family:Monaco, monospace;font-size:14px"><span class="token plain"></span><span class="token comment" style="color:#009900">// so &quot;transform&quot; source for Jest by returning</span><span class="token plain"></span></div><div class="token-line" style="color:#000000;font-family:Monaco, monospace;font-size:14px"><span class="token plain"></span><span class="token comment" style="color:#009900">// the code compiled by tsc</span><span class="token plain"></span></div><div class="token-line" style="color:#000000;font-family:Monaco, monospace;font-size:14px"><span class="token plain"></span><span class="token keyword" style="color:#770088">module</span><span class="token punctuation" style="color:#000000">.</span><span class="token property-access" style="color:#b58900">exports</span><span class="token plain"> </span><span class="token operator" style="color:#000000">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#000000">{</span><span class="token plain"></span></div><div class="token-line" style="color:#000000;font-family:Monaco, monospace;font-size:14px"><span class="token plain">  </span><span class="token function" style="color:#b58900">process</span><span class="token punctuation" style="color:#000000">(</span><span class="token parameter">src</span><span class="token parameter punctuation" style="color:#000000">,</span><span class="token parameter"> fn</span><span class="token parameter punctuation" style="color:#000000">,</span><span class="token parameter"> config</span><span class="token parameter punctuation" style="color:#000000">,</span><span class="token parameter"> options</span><span class="token punctuation" style="color:#000000">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#000000">{</span><span class="token plain"></span></div><div class="token-line" style="color:#000000;font-family:Monaco, monospace;font-size:14px"><span class="token plain">    </span><span class="token keyword" style="color:#770088">const</span><span class="token plain"> bfn </span><span class="token operator" style="color:#000000">=</span><span class="token plain"> fn</span><span class="token punctuation" style="color:#000000">.</span><span class="token method function property-access" style="color:#b58900">replace</span><span class="token punctuation" style="color:#000000">(</span><span class="token plain">__dirname </span><span class="token operator" style="color:#000000">+</span><span class="token plain"> </span><span class="token string" style="color:#aa1111">&#x27;/src&#x27;</span><span class="token punctuation" style="color:#000000">,</span><span class="token plain"> __dirname </span><span class="token operator" style="color:#000000">+</span><span class="token plain"> </span><span class="token string" style="color:#aa1111">&#x27;/build&#x27;</span><span class="token punctuation" style="color:#000000">)</span><span class="token punctuation" style="color:#000000">;</span><span class="token plain"></span></div><div class="token-line" style="color:#000000;font-family:Monaco, monospace;font-size:14px"><span class="token plain">    </span><span class="token keyword" style="color:#770088">const</span><span class="token plain"> bfnParts </span><span class="token operator" style="color:#000000">=</span><span class="token plain"> path</span><span class="token punctuation" style="color:#000000">.</span><span class="token method function property-access" style="color:#b58900">parse</span><span class="token punctuation" style="color:#000000">(</span><span class="token plain">bfn</span><span class="token punctuation" style="color:#000000">)</span><span class="token punctuation" style="color:#000000">;</span><span class="token plain"></span></div><div class="token-line" style="color:#000000;font-family:Monaco, monospace;font-size:14px"><span class="token plain">    </span><span class="token keyword" style="color:#770088">const</span><span class="token plain"> jsfn </span><span class="token operator" style="color:#000000">=</span><span class="token plain"> path</span><span class="token punctuation" style="color:#000000">.</span><span class="token method function property-access" style="color:#b58900">format</span><span class="token punctuation" style="color:#000000">(</span><span class="token punctuation" style="color:#000000">{</span><span class="token plain"> </span><span class="token spread operator" style="color:#000000">...</span><span class="token plain">bfnParts</span><span class="token punctuation" style="color:#000000">,</span><span class="token plain"> base</span><span class="token punctuation" style="color:#000000">:</span><span class="token plain"> bfnParts</span><span class="token punctuation" style="color:#000000">.</span><span class="token property-access" style="color:#b58900">name</span><span class="token plain"> </span><span class="token operator" style="color:#000000">+</span><span class="token plain"> </span><span class="token string" style="color:#aa1111">&#x27;.js&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#000000">}</span><span class="token punctuation" style="color:#000000">)</span><span class="token punctuation" style="color:#000000">;</span><span class="token plain"></span></div><div class="token-line" style="color:#000000;font-family:Monaco, monospace;font-size:14px"><span class="token plain">    </span><span class="token keyword" style="color:#770088">const</span><span class="token plain"> code </span><span class="token operator" style="color:#000000">=</span><span class="token plain"> fs</span><span class="token punctuation" style="color:#000000">.</span><span class="token method function property-access" style="color:#b58900">readFileSync</span><span class="token punctuation" style="color:#000000">(</span><span class="token plain">jsfn</span><span class="token punctuation" style="color:#000000">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#000000">{</span><span class="token plain"> encoding</span><span class="token punctuation" style="color:#000000">:</span><span class="token plain"> </span><span class="token string" style="color:#aa1111">&#x27;utf8&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#000000">}</span><span class="token punctuation" style="color:#000000">)</span><span class="token punctuation" style="color:#000000">;</span><span class="token plain"></span></div><div class="token-line" style="color:#000000;font-family:Monaco, monospace;font-size:14px"><span class="token plain">    </span><span class="token keyword" style="color:#770088">const</span><span class="token plain"> map </span><span class="token operator" style="color:#000000">=</span><span class="token plain"> fs</span><span class="token punctuation" style="color:#000000">.</span><span class="token method function property-access" style="color:#b58900">readFileSync</span><span class="token punctuation" style="color:#000000">(</span><span class="token plain">jsfn </span><span class="token operator" style="color:#000000">+</span><span class="token plain"> </span><span class="token string" style="color:#aa1111">&#x27;.map&#x27;</span><span class="token punctuation" style="color:#000000">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#000000">{</span><span class="token plain"> encoding</span><span class="token punctuation" style="color:#000000">:</span><span class="token plain"> </span><span class="token string" style="color:#aa1111">&#x27;utf8&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#000000">}</span><span class="token punctuation" style="color:#000000">)</span><span class="token punctuation" style="color:#000000">;</span><span class="token plain"></span></div><div class="token-line" style="color:#000000;font-family:Monaco, monospace;font-size:14px"><span class="token plain">    </span><span class="token keyword" style="color:#770088">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#000000">{</span><span class="token plain"> code</span><span class="token punctuation" style="color:#000000">,</span><span class="token plain"> map </span><span class="token punctuation" style="color:#000000">}</span><span class="token punctuation" style="color:#000000">;</span><span class="token plain"></span></div><div class="token-line" style="color:#000000;font-family:Monaco, monospace;font-size:14px"><span class="token plain">  </span><span class="token punctuation" style="color:#000000">}</span><span class="token plain"></span></div><div class="token-line" style="color:#000000;font-family:Monaco, monospace;font-size:14px"><span class="token plain"></span><span class="token punctuation" style="color:#000000">}</span><span class="token punctuation" style="color:#000000">;</span></div></pre><p><span>Put it in a file </span><span><code>tscTransformer.js</code></span><span> and add the following to </span><span><code>jest.config.js</code></span><span>:</span></p><pre class="prism-code language-typescript" style="color:#000000;background-color:#f7f7f7;font-family:Monaco, monospace;font-size:14px;margin-left:10px;margin-right:10px;padding:10px"><div class="token-line" style="color:#000000;font-family:Monaco, monospace;font-size:14px"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#000000;font-family:Monaco, monospace;font-size:14px"><span class="token plain">  </span><span class="token string" style="color:#aa1111">&quot;transform&quot;</span><span class="token punctuation" style="color:#000000">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#000000">{</span><span class="token plain"></span></div><div class="token-line" style="color:#000000;font-family:Monaco, monospace;font-size:14px"><span class="token plain">    </span><span class="token string" style="color:#aa1111">&quot;^.+\\.tsx?$&quot;</span><span class="token punctuation" style="color:#000000">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#000000">[</span><span class="token plain"> </span><span class="token string" style="color:#aa1111">&quot;./tscTransformer.js&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#000000">]</span><span class="token plain"></span></div><div class="token-line" style="color:#000000;font-family:Monaco, monospace;font-size:14px"><span class="token plain">  </span><span class="token punctuation" style="color:#000000">}</span><span class="token punctuation" style="color:#000000">,</span></div></pre><p><span></span></p><p><span>Please </span><a href="/gleanings/mailto%3Ajake%40donham.org"><span>email me</span></a><span> with comments, criticisms, or corrections.</span></p><p><span></span></p></div></body></html>