<html><head><title>Jest and Typescript</title><style>
body {
  background-color: #eeeeee;
}
.content {
  background-color: white;
  padding-top: 80px;
  padding-bottom: 80px;
  padding-left: 120px;
  padding-right: 120px;
  margin-left: auto;
  margin-right: auto;
  max-width: 700px
}
blockquote { margin-block-end: 2em }
p, ul { font-family: serif; font-size: 19px; line-height: 26px }
code { font-family: monospace; font-size: 14px; }
pre { font-family: monospace; font-size: 14px; }
h1, h2, h3, h4, h5, h6 { font-family: sans-serif }
a:link { text-decoration: none; }
a:visited { color: blue }
a:hover {
  background-color: #eeeeee;
}
hr { border-style: solid }
</style>
<script type='module' src='/gleanings/Jest and Typescript.js'></script>
<style data-styled="true" data-styled-version="5.3.0">.fUzHPW{background-color:#f7f7f7;margin-left:10px;margin-right:10px;padding:10px;}/*!sc*/
data-styled.g1[id="sc-bdnxRM"]{content:"fUzHPW,"}/*!sc*/
.kFWJEY:hover{cursor:pointer;}/*!sc*/
data-styled.g2[id="sc-gtsrHT"]{content:"kFWJEY,"}/*!sc*/
.fHUQtx{color:#770088;}/*!sc*/
data-styled.g30[id="sc-cxNHIi"]{content:"fHUQtx,"}/*!sc*/
.hpRDUw{color:#000000;}/*!sc*/
data-styled.g31[id="sc-lmgQwP"]{content:"hpRDUw,"}/*!sc*/
.bojiJp{color:#b58900;}/*!sc*/
data-styled.g32[id="sc-iJCRrE"]{content:"bojiJp,"}/*!sc*/
.bYgUJS{color:#aa1111;}/*!sc*/
data-styled.g33[id="sc-giAqHp"]{content:"bYgUJS,"}/*!sc*/
.dvHFX{color:#009900;}/*!sc*/
data-styled.g34[id="sc-ezzafa"]{content:"dvHFX,"}/*!sc*/
</style>
</head><body><div class="content"><p><span></span><a href="/index"><span>Jake Donham</span></a><span> &gt; </span><a href="/gleanings"><span>Gleanings</span></a><span>  &gt; Jest and Typescript</span></p><h1><span>Jest and Typescript</span></h1><p><span>I&#x27;ve found it difficult to get Jest working smoothly with Typescript. Here are some setups I&#x27;ve tried:</span></p><h2><span>Ts-jest</span></h2><p><span></span><a href="https://kulshekhar.github.io/ts-jest/" class="sc-gtsrHT kFWJEY"><span><code>ts-jest</code></span></a><span> is a Jest transformer that runs the actual Typescript compiler. It functions well and (of course) supports all of Typescript. But it can be unacceptably slow on a large project (this seems to be an </span><a href="https://github.com/kulshekhar/ts-jest/issues/1115" class="sc-gtsrHT kFWJEY"><span>ongoing issue</span></a><span>). It&#x27;s especially frustrating because the standalone Typescript compiler (</span><span><code>tsc --watch</code></span><span>) is able to compile the changes quickly, and I have it running all the time anyway.</span></p><h2><span>Esbuild-jest</span></h2><p><span></span><a href="https://github.com/aelbore/esbuild-jest" class="sc-gtsrHT kFWJEY"><span><code>esbuild-jest</code></span></a><span> is a Jest transformer that calls </span><a href="https://esbuild.github.io/" class="sc-gtsrHT kFWJEY"><span><code>esbuild</code></span></a><span>. It is very fast, but it has some </span><a href="https://github.com/aelbore/esbuild-jest/issues/21" class="sc-gtsrHT kFWJEY"><span>weird bugs</span></a><span>, it doesn&#x27;t seem to return source maps correctly (?), and it doesn&#x27;t seem to be under active development.</span></p><h2><span>Babel</span></h2><p><span>The standard way to transform Typescript for Jest is to use </span><a href="https://jestjs.io/docs/getting-started#using-typescript" class="sc-gtsrHT kFWJEY"><span>Babel</span></a><span>. (I can&#x27;t remember if I tried this.)</span></p><h2><span>Sucrase</span></h2><p><span></span><a href="https://sucrase.io/" class="sc-gtsrHT kFWJEY"><span><code>sucrase</code></span></a><span> is a &quot;super-fast Babel alternative&quot; that can be used as a Jest transformer (?). (I haven&#x27;t tried it.)</span></p><h2><span>Transformer that returns </span><span><code>tsc</code></span><span>-compiled files</span></h2><p><span>Here is a transformer I hacked up that returns the corresponding </span><span><code>tsc</code></span><span>-compiled file. It&#x27;s fast when </span><span><code>tsc</code></span><span> is fast, but I am not sure how reliable it is. Jest and </span><span><code>tsc</code></span><span> both watch the filesystem, so </span><span><code>tsc</code></span><span> may not have finished by the time Jest runs the transformer. And I don&#x27;t know what happens if you change a file that a test depends onâ€”is the transformer called for the test file?</span></p><pre class="sc-bdnxRM fUzHPW"><code><span class="sc-cxNHIi fHUQtx">const</span> path <span class="sc-lmgQwP hpRDUw">=</span> <span class="sc-iJCRrE bojiJp">require</span><span class="sc-lmgQwP hpRDUw">(</span><span class="sc-giAqHp bYgUJS">&#x27;path&#x27;</span><span class="sc-lmgQwP hpRDUw">)</span><span class="sc-lmgQwP hpRDUw">;</span>
<span class="sc-cxNHIi fHUQtx">const</span> fs <span class="sc-lmgQwP hpRDUw">=</span> <span class="sc-iJCRrE bojiJp">require</span><span class="sc-lmgQwP hpRDUw">(</span><span class="sc-giAqHp bYgUJS">&#x27;fs&#x27;</span><span class="sc-lmgQwP hpRDUw">)</span><span class="sc-lmgQwP hpRDUw">;</span>

<span class="sc-ezzafa dvHFX">// we&#x27;re already running tsc --watch</span>
<span class="sc-ezzafa dvHFX">// so &quot;transform&quot; source for Jest by returning</span>
<span class="sc-ezzafa dvHFX">// the code compiled by tsc</span>
module<span class="sc-lmgQwP hpRDUw">.</span>exports <span class="sc-lmgQwP hpRDUw">=</span> <span class="sc-lmgQwP hpRDUw">{</span>
  <span class="sc-iJCRrE bojiJp">process</span><span class="sc-lmgQwP hpRDUw">(</span><span class="sc-lmgQwP hpRDUw">src</span><span class="sc-lmgQwP hpRDUw">,</span><span class="sc-lmgQwP hpRDUw"> fn</span><span class="sc-lmgQwP hpRDUw">,</span><span class="sc-lmgQwP hpRDUw"> config</span><span class="sc-lmgQwP hpRDUw">,</span><span class="sc-lmgQwP hpRDUw"> options</span><span class="sc-lmgQwP hpRDUw">)</span> <span class="sc-lmgQwP hpRDUw">{</span>
    <span class="sc-cxNHIi fHUQtx">const</span> bfn <span class="sc-lmgQwP hpRDUw">=</span> fn<span class="sc-lmgQwP hpRDUw">.</span><span class="sc-iJCRrE bojiJp">replace</span><span class="sc-lmgQwP hpRDUw">(</span>__dirname <span class="sc-lmgQwP hpRDUw">+</span> <span class="sc-giAqHp bYgUJS">&#x27;/src&#x27;</span><span class="sc-lmgQwP hpRDUw">,</span> __dirname <span class="sc-lmgQwP hpRDUw">+</span> <span class="sc-giAqHp bYgUJS">&#x27;/build&#x27;</span><span class="sc-lmgQwP hpRDUw">)</span><span class="sc-lmgQwP hpRDUw">;</span>
    <span class="sc-cxNHIi fHUQtx">const</span> bfnParts <span class="sc-lmgQwP hpRDUw">=</span> path<span class="sc-lmgQwP hpRDUw">.</span><span class="sc-iJCRrE bojiJp">parse</span><span class="sc-lmgQwP hpRDUw">(</span>bfn<span class="sc-lmgQwP hpRDUw">)</span><span class="sc-lmgQwP hpRDUw">;</span>
    <span class="sc-cxNHIi fHUQtx">const</span> jsfn <span class="sc-lmgQwP hpRDUw">=</span> path<span class="sc-lmgQwP hpRDUw">.</span><span class="sc-iJCRrE bojiJp">format</span><span class="sc-lmgQwP hpRDUw">(</span><span class="sc-lmgQwP hpRDUw">{</span> <span class="sc-lmgQwP hpRDUw">...</span>bfnParts<span class="sc-lmgQwP hpRDUw">,</span> base<span class="sc-lmgQwP hpRDUw">:</span> bfnParts<span class="sc-lmgQwP hpRDUw">.</span>name <span class="sc-lmgQwP hpRDUw">+</span> <span class="sc-giAqHp bYgUJS">&#x27;.js&#x27;</span> <span class="sc-lmgQwP hpRDUw">}</span><span class="sc-lmgQwP hpRDUw">)</span><span class="sc-lmgQwP hpRDUw">;</span>
    <span class="sc-cxNHIi fHUQtx">const</span> code <span class="sc-lmgQwP hpRDUw">=</span> fs<span class="sc-lmgQwP hpRDUw">.</span><span class="sc-iJCRrE bojiJp">readFileSync</span><span class="sc-lmgQwP hpRDUw">(</span>jsfn<span class="sc-lmgQwP hpRDUw">,</span> <span class="sc-lmgQwP hpRDUw">{</span> encoding<span class="sc-lmgQwP hpRDUw">:</span> <span class="sc-giAqHp bYgUJS">&#x27;utf8&#x27;</span> <span class="sc-lmgQwP hpRDUw">}</span><span class="sc-lmgQwP hpRDUw">)</span><span class="sc-lmgQwP hpRDUw">;</span>
    <span class="sc-cxNHIi fHUQtx">const</span> map <span class="sc-lmgQwP hpRDUw">=</span> fs<span class="sc-lmgQwP hpRDUw">.</span><span class="sc-iJCRrE bojiJp">readFileSync</span><span class="sc-lmgQwP hpRDUw">(</span>jsfn <span class="sc-lmgQwP hpRDUw">+</span> <span class="sc-giAqHp bYgUJS">&#x27;.map&#x27;</span><span class="sc-lmgQwP hpRDUw">,</span> <span class="sc-lmgQwP hpRDUw">{</span> encoding<span class="sc-lmgQwP hpRDUw">:</span> <span class="sc-giAqHp bYgUJS">&#x27;utf8&#x27;</span> <span class="sc-lmgQwP hpRDUw">}</span><span class="sc-lmgQwP hpRDUw">)</span><span class="sc-lmgQwP hpRDUw">;</span>
    <span class="sc-cxNHIi fHUQtx">return</span> <span class="sc-lmgQwP hpRDUw">{</span> code<span class="sc-lmgQwP hpRDUw">,</span> map <span class="sc-lmgQwP hpRDUw">}</span><span class="sc-lmgQwP hpRDUw">;</span>
  <span class="sc-lmgQwP hpRDUw">}</span>
<span class="sc-lmgQwP hpRDUw">}</span><span class="sc-lmgQwP hpRDUw">;</span></code></pre><p><span>Put it in a file </span><span><code>tscTransformer.js</code></span><span> and add the following to </span><span><code>jest.config.js</code></span><span>:</span></p><pre class="sc-bdnxRM fUzHPW"><code>  <span class="sc-giAqHp bYgUJS">&quot;transform&quot;</span><span class="sc-lmgQwP hpRDUw">:</span> <span class="sc-lmgQwP hpRDUw">{</span>
    <span class="sc-giAqHp bYgUJS">&quot;^.+\\.tsx?$&quot;</span><span class="sc-lmgQwP hpRDUw">:</span> <span class="sc-lmgQwP hpRDUw">[</span> <span class="sc-giAqHp bYgUJS">&quot;./tscTransformer.js&quot;</span> <span class="sc-lmgQwP hpRDUw">]</span>
  <span class="sc-lmgQwP hpRDUw">}</span><span class="sc-lmgQwP hpRDUw">,</span></code></pre><p><span>Please </span><a href="/gleanings/mailto%3Ajake%40donham.org"><span>email me</span></a><span> with comments, criticisms, or corrections.</span></p><p><span></span></p></div></body></html>