<html><head><title>Jest and Typescript</title><meta name="twitter:card" content="summary"/><meta name="twitter:site" content="@jakedonham"/><meta name="twitter:creator" content="@jakedonham"/><meta name="twitter:title" content="Jest and Typescript"/><meta name="twitter:description" content="Jest and Typescript"/><style>
body {
  background-color: #eeeeee;
}
.content {
  background-color: white;
  padding-top: 80px;
  padding-bottom: 80px;
  padding-left: 120px;
  padding-right: 120px;
  margin-left: auto;
  margin-right: auto;
  max-width: 700px
}
blockquote { margin-block-end: 2em }
p, ul { font-family: serif; font-size: 19px; line-height: 26px }
code { font-family: monospace; font-size: 14px; }
pre { font-family: monospace; font-size: 14px; }
h1, h2, h3, h4, h5, h6 { font-family: sans-serif }
a:link { text-decoration: none; }
a:visited { color: blue }
a:hover {
  background-color: #eeeeee;
}
hr { border-style: solid }
</style>
<script type='module' src='/gleanings/Jest and Typescript.js'></script>
<style data-styled="true" data-styled-version="5.3.0">.bOWasK{background-color:#f7f7f7;margin-left:10px;margin-right:10px;padding:10px;overflow:auto;}/*!sc*/
data-styled.g1[id="sc-bdnxRM"]{content:"bOWasK,"}/*!sc*/
.kFWJEY:hover{cursor:pointer;}/*!sc*/
data-styled.g2[id="sc-gtsrHT"]{content:"kFWJEY,"}/*!sc*/
.dvHFX{color:#000000;}/*!sc*/
data-styled.g34[id="sc-ezzafa"]{content:"dvHFX,"}/*!sc*/
.fDDjHD{color:#aa1111;}/*!sc*/
data-styled.g35[id="sc-bYwzuL"]{content:"fDDjHD,"}/*!sc*/
.iehvjW{color:#770088;}/*!sc*/
data-styled.g36[id="sc-kLojOw"]{content:"iehvjW,"}/*!sc*/
.hbusih{color:#b58900;}/*!sc*/
data-styled.g37[id="sc-iklJeh"]{content:"hbusih,"}/*!sc*/
.glZmJR{color:#009900;}/*!sc*/
data-styled.g46[id="sc-iBzEeX"]{content:"glZmJR,"}/*!sc*/
</style>
</head><body><div class="content"><p><span></span><a href="/index"><span>Jake Donham</span></a><span> &gt; </span><a href="/gleanings"><span>Gleanings</span></a><span>  &gt; Jest and Typescript</span></p><h1 id="jest-and-typescript"><span>Jest and Typescript</span></h1><p><span>I&#x27;ve found it difficult to get Jest working smoothly with Typescript. Here are some setups I&#x27;ve tried:</span></p><h2 id="ts-jest"><span>Ts-jest</span></h2><p><span></span><a href="https://kulshekhar.github.io/ts-jest/" class="sc-gtsrHT kFWJEY"><span><code>ts-jest</code></span></a><span> is a Jest transformer that runs the actual Typescript compiler. It functions well and (of course) supports all of Typescript. But it can be unacceptably slow on a large project (this seems to be an </span><a href="https://github.com/kulshekhar/ts-jest/issues/1115" class="sc-gtsrHT kFWJEY"><span>ongoing issue</span></a><span>). It&#x27;s especially frustrating because the standalone Typescript compiler (</span><span><code>tsc --watch</code></span><span>) is able to compile the changes quickly, and I have it running all the time anyway.</span></p><h2 id="esbuild-jest"><span>Esbuild-jest</span></h2><p><span></span><a href="https://github.com/aelbore/esbuild-jest" class="sc-gtsrHT kFWJEY"><span><code>esbuild-jest</code></span></a><span> is a Jest transformer that calls </span><a href="https://esbuild.github.io/" class="sc-gtsrHT kFWJEY"><span><code>esbuild</code></span></a><span>. It is very fast, but it has some </span><a href="https://github.com/aelbore/esbuild-jest/issues/21" class="sc-gtsrHT kFWJEY"><span>weird bugs</span></a><span>, it doesn&#x27;t seem to return source maps correctly (?), and it doesn&#x27;t seem to be under active development.</span></p><h2 id="babel"><span>Babel</span></h2><p><span>The standard way to transform Typescript for Jest is to use </span><a href="https://jestjs.io/docs/getting-started#using-typescript" class="sc-gtsrHT kFWJEY"><span>Babel</span></a><span>. (I can&#x27;t remember if I tried this.)</span></p><h2 id="sucrase"><span>Sucrase</span></h2><p><span></span><a href="https://sucrase.io/" class="sc-gtsrHT kFWJEY"><span><code>sucrase</code></span></a><span> is a &quot;super-fast Babel alternative&quot; that can be used as a Jest transformer (?). (I haven&#x27;t tried it.)</span></p><h2 id="transformer-that-returns-tsc-compiled-files"><span>Transformer that returns </span><span><code>tsc</code></span><span>-compiled files</span></h2><p><span>Here is a transformer I hacked up that returns the corresponding </span><span><code>tsc</code></span><span>-compiled file. It&#x27;s fast when </span><span><code>tsc</code></span><span> is fast, but I am not sure how reliable it is. Jest and </span><span><code>tsc</code></span><span> both watch the filesystem, so </span><span><code>tsc</code></span><span> may not have finished by the time Jest runs the transformer. And I don&#x27;t know what happens if you change a file that a test depends onâ€”is the transformer called for the test file?</span></p><pre class="sc-bdnxRM bOWasK"><code><span class="sc-kLojOw iehvjW">const</span> path <span class="sc-ezzafa dvHFX">=</span> <span class="sc-iklJeh hbusih">require</span><span class="sc-ezzafa dvHFX">(</span><span class="sc-bYwzuL fDDjHD">&#x27;path&#x27;</span><span class="sc-ezzafa dvHFX">)</span><span class="sc-ezzafa dvHFX">;</span>
<span class="sc-kLojOw iehvjW">const</span> fs <span class="sc-ezzafa dvHFX">=</span> <span class="sc-iklJeh hbusih">require</span><span class="sc-ezzafa dvHFX">(</span><span class="sc-bYwzuL fDDjHD">&#x27;fs&#x27;</span><span class="sc-ezzafa dvHFX">)</span><span class="sc-ezzafa dvHFX">;</span>

<span class="sc-iBzEeX glZmJR">// we&#x27;re already running tsc --watch</span>
<span class="sc-iBzEeX glZmJR">// so &quot;transform&quot; source for Jest by returning</span>
<span class="sc-iBzEeX glZmJR">// the code compiled by tsc</span>
module<span class="sc-ezzafa dvHFX">.</span>exports <span class="sc-ezzafa dvHFX">=</span> <span class="sc-ezzafa dvHFX">{</span>
  <span class="sc-iklJeh hbusih">process</span><span class="sc-ezzafa dvHFX">(</span><span class="sc-ezzafa dvHFX">src</span><span class="sc-ezzafa dvHFX">,</span><span class="sc-ezzafa dvHFX"> fn</span><span class="sc-ezzafa dvHFX">,</span><span class="sc-ezzafa dvHFX"> config</span><span class="sc-ezzafa dvHFX">,</span><span class="sc-ezzafa dvHFX"> options</span><span class="sc-ezzafa dvHFX">)</span> <span class="sc-ezzafa dvHFX">{</span>
    <span class="sc-kLojOw iehvjW">const</span> bfn <span class="sc-ezzafa dvHFX">=</span> fn<span class="sc-ezzafa dvHFX">.</span><span class="sc-iklJeh hbusih">replace</span><span class="sc-ezzafa dvHFX">(</span>__dirname <span class="sc-ezzafa dvHFX">+</span> <span class="sc-bYwzuL fDDjHD">&#x27;/src&#x27;</span><span class="sc-ezzafa dvHFX">,</span> __dirname <span class="sc-ezzafa dvHFX">+</span> <span class="sc-bYwzuL fDDjHD">&#x27;/build&#x27;</span><span class="sc-ezzafa dvHFX">)</span><span class="sc-ezzafa dvHFX">;</span>
    <span class="sc-kLojOw iehvjW">const</span> bfnParts <span class="sc-ezzafa dvHFX">=</span> path<span class="sc-ezzafa dvHFX">.</span><span class="sc-iklJeh hbusih">parse</span><span class="sc-ezzafa dvHFX">(</span>bfn<span class="sc-ezzafa dvHFX">)</span><span class="sc-ezzafa dvHFX">;</span>
    <span class="sc-kLojOw iehvjW">const</span> jsfn <span class="sc-ezzafa dvHFX">=</span> path<span class="sc-ezzafa dvHFX">.</span><span class="sc-iklJeh hbusih">format</span><span class="sc-ezzafa dvHFX">(</span><span class="sc-ezzafa dvHFX">{</span> <span class="sc-ezzafa dvHFX">...</span>bfnParts<span class="sc-ezzafa dvHFX">,</span> base<span class="sc-ezzafa dvHFX">:</span> bfnParts<span class="sc-ezzafa dvHFX">.</span>name <span class="sc-ezzafa dvHFX">+</span> <span class="sc-bYwzuL fDDjHD">&#x27;.js&#x27;</span> <span class="sc-ezzafa dvHFX">}</span><span class="sc-ezzafa dvHFX">)</span><span class="sc-ezzafa dvHFX">;</span>
    <span class="sc-kLojOw iehvjW">const</span> code <span class="sc-ezzafa dvHFX">=</span> fs<span class="sc-ezzafa dvHFX">.</span><span class="sc-iklJeh hbusih">readFileSync</span><span class="sc-ezzafa dvHFX">(</span>jsfn<span class="sc-ezzafa dvHFX">,</span> <span class="sc-ezzafa dvHFX">{</span> encoding<span class="sc-ezzafa dvHFX">:</span> <span class="sc-bYwzuL fDDjHD">&#x27;utf8&#x27;</span> <span class="sc-ezzafa dvHFX">}</span><span class="sc-ezzafa dvHFX">)</span><span class="sc-ezzafa dvHFX">;</span>
    <span class="sc-kLojOw iehvjW">const</span> map <span class="sc-ezzafa dvHFX">=</span> fs<span class="sc-ezzafa dvHFX">.</span><span class="sc-iklJeh hbusih">readFileSync</span><span class="sc-ezzafa dvHFX">(</span>jsfn <span class="sc-ezzafa dvHFX">+</span> <span class="sc-bYwzuL fDDjHD">&#x27;.map&#x27;</span><span class="sc-ezzafa dvHFX">,</span> <span class="sc-ezzafa dvHFX">{</span> encoding<span class="sc-ezzafa dvHFX">:</span> <span class="sc-bYwzuL fDDjHD">&#x27;utf8&#x27;</span> <span class="sc-ezzafa dvHFX">}</span><span class="sc-ezzafa dvHFX">)</span><span class="sc-ezzafa dvHFX">;</span>
    <span class="sc-kLojOw iehvjW">return</span> <span class="sc-ezzafa dvHFX">{</span> code<span class="sc-ezzafa dvHFX">,</span> map <span class="sc-ezzafa dvHFX">}</span><span class="sc-ezzafa dvHFX">;</span>
  <span class="sc-ezzafa dvHFX">}</span>
<span class="sc-ezzafa dvHFX">}</span><span class="sc-ezzafa dvHFX">;</span></code></pre><p><span>Put it in a file </span><span><code>tscTransformer.js</code></span><span> and add the following to </span><span><code>jest.config.js</code></span><span>:</span></p><pre class="sc-bdnxRM bOWasK"><code>  <span class="sc-bYwzuL fDDjHD">&quot;transform&quot;</span><span class="sc-ezzafa dvHFX">:</span> <span class="sc-ezzafa dvHFX">{</span>
    <span class="sc-bYwzuL fDDjHD">&quot;^.+\\.tsx?$&quot;</span><span class="sc-ezzafa dvHFX">:</span> <span class="sc-ezzafa dvHFX">[</span> <span class="sc-bYwzuL fDDjHD">&quot;./tscTransformer.js&quot;</span> <span class="sc-ezzafa dvHFX">]</span>
  <span class="sc-ezzafa dvHFX">}</span><span class="sc-ezzafa dvHFX">,</span></code></pre><p><span>Please </span><a href="/gleanings/mailto%3Ajake%40donham.org"><span>email me</span></a><span> with comments, criticisms, or corrections.</span></p><p><span></span></p></div></body></html>